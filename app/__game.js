define(function(require,exports,module){require("RAF");var e=require("th");function a(i,h){var i=i||0,h=h||1;return Math.round(Math.random()*(h-i)+i)}var g=(function(){var j={};for(var h=-100;h<=100;h++){j[h]=Math.atan(h/10)}return j})();function f(){var K=this,U={x:$(window).width(),y:$(window).height()},D={x:(U.x/2)>>0,y:(U.y/2)>>0},am=/android/gi.test(navigator.appVersion),an=true,ad=1,r=0,P=0,Y=0.3,l=1,af=0,v=ap("style/images/atlas2.png"),R={die:ak("sound/sfx_hit.ogg"),jump:ak("sound/sfx_wing.ogg"),score:ak("sound/sfx_point.ogg")},ac=0,t=288,I=512,al=U.y/I,aj=U.y,M=(t*al)>>0,ao=Math.ceil(U.x/(t*al)),au=[],y=52,j=320,i=ad*3,aa=130,n=140,C=-20,A=225,x=0,G=25,W=(G/2)>>0,H=[[112,646],[168,646]],Q=D.x-y,ae=null,p=-6,aq=D.x+18,B=D.x-18-y,ai=U.y-P-G,k=Math.ceil(U.x/A),Z=1,at=0,m=(function(){return new e(document.getElementById("stage"))})(),u=document.createElement("canvas"),F=u.getContext("2d");u.width=U.x;u.height=U.y;u.style.cssText="width:"+U.x+"px;height:"+U.y+"px;";function ap(aw){var av=document.createElement("img");av.src=aw;av.onload=o;return av}function ak(ax){var aw=new Audio(),av="oncanplaythrough" in aw?"canplaythrough":"load";aw.src=ax;aw.addEventListener(av,o,false);return aw}function X(){var av=this;this.dead=false;this.deadTime=0;this.deadGround=false;this.yspeed=0;this.y=(U.y/2)>>0;this.sprite=[[230,762],[230,814],[230,866],[275,762]];this.spriteIndex=0;this.direction=0;this.size={x:35,y:25};this.halfSize={x:18,y:13};this.jump=function(){this.yspeed=p};this.move=function(){this.y=(this.y<=0)?this.yspeed:(this.y+this.yspeed);this.yspeed+=Y*Z;this.direction=this.deadGround===false?g[(10*this.yspeed/i)>>0]:Math.PI};this.spriteTimer=(function(){av.spriteIndex=av.spriteIndex>=2?0:(av.spriteIndex+1);return setTimeout(arguments.callee,100)})()}function ar(ax,ay,az,aw){var av=this;this.width=ax||y,this.mouthWidth=ay||aa,this.mouthPos=az||(U.y-this.mouthWidth-n)/2+n*Math.random()+C;this.dead=false;this.pos=aw||U.x;this.number=++r;this.passed=false;this.move=function(){this.pos-=i*Z;if(this.pos<-this.width){this.dead=true}}}function L(){if(ae!==null){ae.jump()}}function w(){}function T(av){var av=av||window.event;av.preventDefault()}function S(){if(ae.y>ai){ae.dead=true;ae.deadGround=true;ae.deadTime=(+new Date)-1000;return}for(var aw=0,av=au.length;aw<av;aw++){if(au[aw].passed===true){continue}if((au[aw].pos<aq)&&(au[aw].pos>B)){if((ae.y<au[aw].mouthPos)||(ae.y+ae.size.y>au[aw].mouthPos+au[aw].mouthWidth)){if(!ae.dead){s();ae.dead=true;if(ae.deadTime===0){ae.deadTime=+new Date}R.die.play()}return}break}else{if(au[aw].pos<Q){R.score.play();au[aw].passed=true;x++}}}}function s(){m.ontouchstart=function(){};m.ontouchmove=function(av){av.preventDefault()};m.ontouchend=function(){}}function N(){m.ontouchstart=L;m.ontouchmove=T;m.ontouchend=w}function J(){ae.move();if(ae.dead===true){ae.spriteIndex=3}F.save();F.translate(D.x,ae.y+ae.halfSize.y);F.rotate(ae.direction);F.drawImage(v,ae.sprite[ae.spriteIndex][0],ae.sprite[ae.spriteIndex][1],ae.size.x,ae.size.y,-ae.halfSize.x,-ae.halfSize.y,ae.size.x,ae.size.y);F.restore()}function q(){for(var ax=0,av=au.length;ax<av;ax++){if(au[ax].dead===true){au[ax]={};au.splice(ax,1);var aw=new ar();aw.pos=au[av-2].pos+A;au.push(aw);ax--}else{au[ax].move();F.drawImage(v,H[0][0],H[0][1],y,j,au[ax].pos,au[ax].mouthPos-j,y,j);F.drawImage(v,H[1][0],H[1][1],y,j,au[ax].pos,au[ax].mouthPos+aa,y,j)}}}function ag(){if(an===false){E();S();if(ae.dead===true){if(ae.deadGround===true){V()}else{ad=0;i=0}}ac-=ad*Z;if(!am){ac=ac<=-M?0:ac;for(var ay=0;ay<=ao;ay++){F.drawImage(v,0,0,t,I,ac+M*ay,0,M,aj)}}else{}q();J();if(ae.deadTime>0){var aw=(+new Date)-ae.deadTime,av=250;if(aw<av){var ax=(1-aw/av).toPrecision(1);F.save();F.fillStyle="#fff";F.globalAlpha=ax;F.fillRect(0,0,U.x,U.y);F.restore()}}F.save();F.fillStyle="#fff";F.strokeStyle="#F90";F.font="normal bold 50px Verdana";F.fillText(x,10,65);F.strokeText(x,10,65);F.font="normal bold 12px Verdana";F.fillText("Level",10,15);F.restore();requestNextAnimationFrame(arguments.callee)}}function E(){F.clearRect(0,0,U.x,U.y)}function z(){$("#game").append(u);E();$(".btn").css({left:"",top:"",right:10,top:10});$("#play").css({top:U.y/2-30,left:U.x/2-60});$("#reset").css({top:U.y/2+40,left:U.x/2-60});$("#level").css({top:U.y/2-40,left:U.x/2-100});$("#stage>div").css({width:U.x,height:U.y,position:"absolute",top:0,left:0}).each(function(){$(this).css("z-index",10-$(this).index())})}function ah(){z();ad=1;i=3;ae=null;ae=new X();ac=0;r=0;au=(function(){var ax=[],av=0;for(var aw=0;aw<k;aw++){(function(){av=new ar();av.pos=av.pos+(((aw+0.5)*A)>>0);ax.push(av)})()}return ax})();x=0;window.addEventListener("resize",z,false);s();$(".btn,.ldtxt").hide();$("#play").show();u.style.display="block"}function o(av){if(typeof av=="function"){if(af>=l){av();readyCallback=null}else{readyCallback=av}}else{af++;if(af>=l){if(typeof readyCallback=="function"){readyCallback()}}}}function O(){N();an=false;$("#mask,#reset,#play,#level").hide();ag()}function h(){s();an=true;$("#play,#mask").show();$("#pause").hide()}function ab(){if(am===true){location.reload()}else{ah();O()}}function V(){s();an=true;$(".btn").hide();$("#level").html("Level <span>"+x+"</span>");$("#reset,#mask,#level").show()}this.init=ah;this.ready=o;this.play=O;this.reset=ab;this.pause=h;this.gameover=V;this.playMusic=function(){R.score.play()}}module.exports=f});